<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEO 關鍵字排名追蹤器 (BYOK)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Identity Services SDK -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">

    <div class="max-w-4xl mx-auto px-4 py-12">
        <header class="mb-12 text-center">
            <h1 class="text-4xl font-extrabold mb-4 bg-gradient-to-r from-blue-400 to-emerald-400 bg-clip-text text-transparent">
                SEO Ranking Tracker
            </h1>
            <!-- <p class="text-slate-400">純前端、無後端、BYOK 模式的 SEO 關鍵字排名紀錄工具</p> -->
        </header>

        <!-- Tab 導航 -->
        <div class="flex justify-center space-x-4 mb-8">
            <button onclick="switchTab('query')" id="tab-query" class="px-6 py-2 rounded-full font-semibold transition-all bg-blue-600 text-white">
                查詢與紀錄
            </button>
            <button onclick="switchTab('settings')" id="tab-settings" class="px-6 py-2 rounded-full font-semibold transition-all bg-slate-800 text-slate-300 hover:bg-slate-700">
                API 設定
            </button>
        </div>

        <!-- 查詢區 -->
        <div id="section-query" class="space-y-6">
            <div class="glass-card p-8 rounded-2xl shadow-xl">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">目標網址 (Domain)</label>
                        <input type="text" id="targetUrl" placeholder="例如: example.com" 
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">SEO 關鍵字</label>
                        <input type="text" id="keyword" placeholder="例如: 台北咖啡廳推薦" 
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="mt-8 flex flex-col items-center">
                    <button onclick="runTracker()" id="btn-run" class="w-full md:w-64 bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-emerald-900/20 transition-all flex justify-center items-center">
                        <span id="btn-text">查詢並記錄排名</span>
                        <svg id="loading-spinner" class="hidden animate-spin ml-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                    <p id="status-msg" class="mt-4 text-sm text-slate-400"></p>
                </div>
            </div>

            <!-- 查詢結果展示 -->
            <div id="result-card" class="hidden glass-card p-6 rounded-2xl border-l-4 border-emerald-500">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="text-xl font-bold" id="res-keyword"></h3>
                        <p class="text-slate-400 text-sm" id="res-url"></p>
                    </div>
                    <div class="text-right">
                        <span class="text-4xl font-black text-emerald-400" id="res-rank">--</span>
                        <span class="text-slate-500 text-sm block">搜尋排名</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 設定區 -->
        <div id="section-settings" class="hidden space-y-6">
            <div class="glass-card p-8 rounded-2xl">
                <h2 class="text-2xl font-bold mb-6 text-blue-400">Google API 整合設定</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">Google Custom Search API Key</label>
                        <input type="password" id="apiKey" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">Search Engine ID (CX)</label>
                        <input type="text" id="cx" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">Google Sheet ID (試算表網址中的長代碼)</label>
                        <input type="text" id="sheetId" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">OAuth 2.0 Client ID (用於寫入試算表)</label>
                        <input type="text" id="clientId" placeholder="若要自動紀錄，請填寫此欄位" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <div class="mt-8 flex justify-between items-center">
                    <button onclick="saveSettings()" class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-lg font-bold transition-all">
                        儲存設定
                    </button>
                    <span id="save-status" class="text-emerald-400 text-sm font-medium"></span>
                </div>
                
                <div class="mt-8 p-4 bg-slate-800/50 rounded-lg border border-slate-700 text-xs text-slate-400 leading-relaxed">
                    <p class="font-bold mb-1 text-slate-300">如何設定？</p>
                    1. 前往 <a href="https://console.cloud.google.com/" target="_blank" class="underline">Google Cloud Console</a> 建立專案。<br>
                    2. 啟用 <b>Custom Search API</b> 與 <b>Google Sheets API</b>。<br>
                    3. 在「憑證」建立 API 金鑰與 OAuth 2.0 用戶端 ID (網頁應用程式)。<br>
                    4. 前往 <a href="https://programmablesearchengine.google.com/" target="_blank" class="underline">Programmable Search Engine</a> 建立搜尋引擎獲取 CX。<br>
                    5. **重要**：OAuth 設定中的「授權的 JavaScript 來源」需填寫您的網址 (或 localhost)。
                </div>
            </div>
        </div>
    </div>

    <!-- 提示框 -->
    <div id="toast" class="fixed bottom-8 right-8 transform translate-y-20 opacity-0 transition-all duration-300 px-6 py-3 rounded-lg shadow-2xl font-semibold pointer-events-none"></div>

    <script>
        let config = {
            apiKey: '',
            cx: '',
            sheetId: '',
            clientId: ''
        };

        let accessToken = null;
        let tokenClient = null;

        // 初始化
        window.onload = () => {
            loadSettings();
            initGoogleAuth();
        };

        // 載入設定
        function loadSettings() {
            const saved = localStorage.getItem('seo_tracker_config');
            if (saved) {
                config = JSON.parse(saved);
                document.getElementById('apiKey').value = config.apiKey || '';
                document.getElementById('cx').value = config.cx || '';
                document.getElementById('sheetId').value = config.sheetId || '';
                document.getElementById('clientId').value = config.clientId || '';
            }
        }

        // 儲存設定
        function saveSettings() {
            config.apiKey = document.getElementById('apiKey').value.trim();
            config.cx = document.getElementById('cx').value.trim();
            config.sheetId = document.getElementById('sheetId').value.trim();
            config.clientId = document.getElementById('clientId').value.trim();

            localStorage.setItem('seo_tracker_config', JSON.stringify(config));
            
            const status = document.getElementById('save-status');
            status.textContent = '設定已儲存！';
            showToast('設定儲存成功', 'success');
            setTimeout(() => status.textContent = '', 3000);
            
            // 重新初始化 Auth
            initGoogleAuth();
        }

        // Tab 切換
        function switchTab(tab) {
            const qSec = document.getElementById('section-query');
            const sSec = document.getElementById('section-settings');
            const qTab = document.getElementById('tab-query');
            const sTab = document.getElementById('tab-settings');

            if (tab === 'query') {
                qSec.classList.remove('hidden');
                sSec.classList.add('hidden');
                qTab.classList.add('bg-blue-600', 'text-white');
                qTab.classList.remove('bg-slate-800', 'text-slate-300');
                sTab.classList.add('bg-slate-800', 'text-slate-300');
                sTab.classList.remove('bg-blue-600', 'text-white');
            } else {
                sSec.classList.remove('hidden');
                qSec.classList.add('hidden');
                sTab.classList.add('bg-blue-600', 'text-white');
                sTab.classList.remove('bg-slate-800', 'text-slate-300');
                qTab.classList.add('bg-slate-800', 'text-slate-300');
                qTab.classList.remove('bg-blue-600', 'text-white');
            }
        }

        // 初始化 Google Identity Services
        function initGoogleAuth() {
            if (!config.clientId) return;
            
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: config.clientId,
                    scope: 'https://www.googleapis.com/auth/spreadsheets',
                    callback: (response) => {
                        if (response.error !== undefined) {
                            showToast('授權失敗: ' + response.error, 'error');
                            return;
                        }
                        accessToken = response.access_token;
                        showToast('授權成功，正在寫入試算表...', 'success');
                        writeToSheet();
                    },
                });
            } catch (e) {
                console.error("Auth Init Error", e);
            }
        }

        // 主執行流程
        async function runTracker() {
            if (!config.apiKey || !config.cx) {
                showToast('請先至設定區填寫 API 金鑰', 'error');
                switchTab('settings');
                return;
            }

            const targetUrl = document.getElementById('targetUrl').value.trim();
            const keyword = document.getElementById('keyword').value.trim();

            if (!targetUrl || !keyword) {
                showToast('請輸入網址與關鍵字', 'error');
                return;
            }

            setLoading(true);
            updateStatus('搜尋引擎爬取中...');

            try {
                const rank = await getSearchRank(keyword, targetUrl);
                displayResult(keyword, targetUrl, rank);
                
                if (config.sheetId && config.clientId) {
                    updateStatus('準備寫入 Google Sheets...');
                    handleSheetRecording(keyword, targetUrl, rank);
                } else {
                    updateStatus('查詢完成 (未設定自動紀錄)');
                    setLoading(false);
                }
            } catch (error) {
                showToast('查詢失敗: ' + error.message, 'error');
                updateStatus('查詢發生錯誤');
                setLoading(false);
            }
        }

        // 串接 Google Custom Search (支援抓取前 100 名)
        async function getSearchRank(keyword, target) {
            let foundRank = -1;
            const itemsPerPage = 10;
            const maxPages = 10; // 100 排名

            for (let page = 0; page < maxPages; page++) {
                const start = (page * itemsPerPage) + 1;
                const url = `https://customsearch.googleapis.com/customsearch/v1?key=${config.apiKey}&cx=${config.cx}&q=${encodeURIComponent(keyword)}&start=${start}`;
                
                const response = await fetch(url);
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message);
                }

                if (!data.items || data.items.length === 0) break;

                for (let i = 0; i < data.items.length; i++) {
                    const item = data.items[i];
                    if (item.link.includes(target) || item.displayLink.includes(target)) {
                        foundRank = start + i;
                        return foundRank;
                    }
                }

                // 如果這頁已經比總結果數還多，就跳出
                if (!data.queries.nextPage) break;
            }

            return foundRank;
        }

        // 處理 Sheet 紀錄流程
        function handleSheetRecording(keyword, url, rank) {
            if (!accessToken) {
                // 如果沒有 Token，啟動授權
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                writeToSheet();
            }
        }

        // 寫入試算表
        async function writeToSheet() {
            const keyword = document.getElementById('keyword').value.trim();
            const targetUrl = document.getElementById('targetUrl').value.trim();
            const rank = document.getElementById('res-rank').textContent;
            const date = new Date().toLocaleString('zh-TW');

            const values = [[date, keyword, targetUrl, rank]];
            const range = 'Sheet1!A:D'; // 假設寫入 Sheet1

            try {
                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${config.sheetId}/values/${range}:append?valueInputOption=USER_ENTERED`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ values })
                });

                const result = await response.json();
                if (result.error) {
                    if (result.error.status === 'UNAUTHENTICATED') {
                        accessToken = null;
                        tokenClient.requestAccessToken();
                    } else {
                        throw new Error(result.error.message);
                    }
                } else {
                    showToast('數據已成功同步至試算表', 'success');
                    updateStatus('所有任務已完成！');
                }
            } catch (e) {
                showToast('寫入失敗: ' + e.message, 'error');
            } finally {
                setLoading(false);
            }
        }

        // UI 輔助函式
        function setLoading(isLoading) {
            const btn = document.getElementById('btn-run');
            const text = document.getElementById('btn-text');
            const spinner = document.getElementById('loading-spinner');

            if (isLoading) {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                text.textContent = '處理中...';
                spinner.classList.remove('hidden');
            } else {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                text.textContent = '查詢並記錄排名';
                spinner.classList.add('hidden');
            }
        }

        function updateStatus(msg) {
            document.getElementById('status-msg').textContent = msg;
        }

        function displayResult(keyword, url, rank) {
            const card = document.getElementById('result-card');
            const rankEl = document.getElementById('res-rank');
            
            card.classList.remove('hidden');
            document.getElementById('res-keyword').textContent = keyword;
            document.getElementById('res-url').textContent = url;
            
            if (rank > 0) {
                rankEl.textContent = rank;
                rankEl.className = 'text-4xl font-black text-emerald-400';
            } else {
                rankEl.textContent = '100+';
                rankEl.className = 'text-4xl font-black text-rose-400';
            }
        }

        function showToast(msg, type) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = `fixed bottom-8 right-8 px-6 py-3 rounded-lg shadow-2xl font-semibold z-50 transition-all duration-300 ${
                type === 'success' ? 'bg-emerald-600 text-white' : 'bg-rose-600 text-white'
            }`;
            
            toast.style.opacity = '1';
            toast.style.transform = 'translateY(0)';
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
            }, 3000);
        }
    </script>
</body>
</html>