<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEO æ’åè¿½è¹¤èˆ‡è¨˜éŒ„å·¥å…·</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Google Identity Services (GSI) -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- å¼•å…¥ Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* ç°¡å–®çš„è¼‰å…¥å‹•ç•« */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #ffffff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-gray-800">

    <div class="max-w-4xl mx-auto py-10 px-4 sm:px-6 lg:px-8">
        <!-- æ¨™é¡Œå€ -->
        <div class="mb-8 text-center">
            <h1 class="text-3xl font-extrabold text-gray-900 sm:text-4xl flex items-center justify-center gap-3">
                <i data-lucide="bar-chart-2" class="w-10 h-10 text-blue-600"></i>
                SEO æ’åè¿½è¹¤å·¥å…·
            </h1>
            <p class="mt-3 text-xl text-gray-500">ç´”å‰ç«¯é‹è¡Œï¼Œè‡ªå¸¶é‡‘é‘° (BYOK)ï¼Œè‡ªå‹•åŒæ­¥è‡³ Google Sheets</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- å·¦å´ï¼šè¨­å®šå€ -->
            <div class="md:col-span-1">
                <div class="bg-white shadow rounded-lg px-4 py-5 sm:p-6 border-t-4 border-blue-500">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 flex items-center gap-2 mb-4">
                        <i data-lucide="settings" class="w-5 h-5 text-gray-500"></i> API è¨­å®š
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label for="serpApiKey" class="block text-sm font-medium text-gray-700">SerpApi Key</label>
                            <input type="password" id="serpApiKey" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="è¼¸å…¥ SerpApi Key">
                        </div>
                        <div>
                            <label for="googleClientId" class="block text-sm font-medium text-gray-700">Google Client ID (OAuth)</label>
                            <input type="password" id="googleClientId" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="è¼¸å…¥ Google OAuth Client ID">
                        </div>
                        <div>
                            <label for="googleSheetId" class="block text-sm font-medium text-gray-700">Google Sheet ID</label>
                            <input type="text" id="googleSheetId" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="ä¾‹å¦‚: 1BxiMVs0XRY...">
                        </div>
                        <button id="saveSettingsBtn" class="w-full bg-blue-600 border border-transparent rounded-md shadow-sm py-2 px-4 inline-flex justify-center text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            å„²å­˜è¨­å®š
                        </button>
                    </div>
                </div>
            </div>

            <!-- å³å´ï¼šæŸ¥è©¢å€èˆ‡ç´€éŒ„ -->
            <div class="md:col-span-2 space-y-6">
                <!-- æŸ¥è©¢å¡ç‰‡ -->
                <div class="bg-white shadow rounded-lg px-4 py-5 sm:p-6 border-t-4 border-green-500">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 flex items-center gap-2 mb-4">
                        <i data-lucide="search" class="w-5 h-5 text-gray-500"></i> æŸ¥è©¢ç›®æ¨™
                    </h3>
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                        <div>
                            <label for="targetUrl" class="block text-sm font-medium text-gray-700">ç›®æ¨™ç¶²å€ (Target URL)</label>
                            <input type="text" id="targetUrl" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="ä¾‹å¦‚: example.com">
                        </div>
                        <div>
                            <label for="keyword" class="block text-sm font-medium text-gray-700">ç›®æ¨™é—œéµå­— (Keyword)</label>
                            <input type="text" id="keyword" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="è¼¸å…¥è¦æŸ¥è©¢çš„é—œéµå­—">
                        </div>
                    </div>
                    <div class="mt-5">
                        <button id="searchBtn" class="w-full bg-green-600 border border-transparent rounded-md shadow-sm py-3 px-4 inline-flex justify-center items-center text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                            <span id="btnText" class="flex items-center gap-2"><i data-lucide="zap" class="w-5 h-5"></i> æŸ¥è©¢ä¸¦è¨˜éŒ„è‡³ Google Sheets</span>
                            <span id="btnLoader" class="hidden"><div class="spinner mr-2"></div> è™•ç†ä¸­...</span>
                        </button>
                    </div>
                </div>

                <!-- ç‹€æ…‹æ—¥èªŒå¡ç‰‡ -->
                <div class="bg-gray-900 shadow rounded-lg px-4 py-5 sm:p-6 text-gray-300 font-mono text-sm h-64 overflow-y-auto">
                    <h3 class="text-gray-100 flex items-center gap-2 mb-3 pb-2 border-b border-gray-700">
                        <i data-lucide="terminal" class="w-4 h-4"></i> åŸ·è¡Œæ—¥èªŒ
                    </h3>
                    <div id="logContainer" class="space-y-2">
                        <div class="text-gray-500">> ç³»çµ±å·²å°±ç·’ï¼Œç­‰å¾…è¼¸å…¥æŒ‡ä»¤...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ– Lucide Icons
        lucide.createIcons();

        // å–å¾— DOM å…ƒç´ 
        const els = {
            serpApiKey: document.getElementById('serpApiKey'),
            googleClientId: document.getElementById('googleClientId'),
            googleSheetId: document.getElementById('googleSheetId'),
            saveSettingsBtn: document.getElementById('saveSettingsBtn'),
            targetUrl: document.getElementById('targetUrl'),
            keyword: document.getElementById('keyword'),
            searchBtn: document.getElementById('searchBtn'),
            btnText: document.getElementById('btnText'),
            btnLoader: document.getElementById('btnLoader'),
            logContainer: document.getElementById('logContainer')
        };

        let currentSearchData = null; // æš«å­˜æŸ¥è©¢çµæœä»¥ä¾¿å¾ŒçºŒå¯«å…¥

        // --- 1. è¨­å®šç®¡ç† (LocalStorage) ---

        function loadSettings() {
            els.serpApiKey.value = localStorage.getItem('seo_serpApiKey') || '';
            els.googleClientId.value = localStorage.getItem('seo_googleClientId') || '';
            els.googleSheetId.value = localStorage.getItem('seo_googleSheetId') || '';
            logMsg('INFO', 'è¨­å®šå·²å¾æœ¬æ©Ÿè¼‰å…¥ã€‚');
        }

        els.saveSettingsBtn.addEventListener('click', () => {
            localStorage.setItem('seo_serpApiKey', els.serpApiKey.value.trim());
            localStorage.setItem('seo_googleClientId', els.googleClientId.value.trim());
            localStorage.setItem('seo_googleSheetId', els.googleSheetId.value.trim());
            logMsg('SUCCESS', 'API è¨­å®šå·²æˆåŠŸå„²å­˜ã€‚');
            alert('è¨­å®šå·²å„²å­˜ï¼');
        });

        // æ—¥èªŒè¼”åŠ©å‡½æ•¸
        function logMsg(type, msg) {
            const time = new Date().toLocaleTimeString();
            let colorClass = 'text-gray-300';
            if (type === 'SUCCESS') colorClass = 'text-green-400';
            if (type === 'ERROR') colorClass = 'text-red-400';
            if (type === 'WARNING') colorClass = 'text-yellow-400';

            const logEl = document.createElement('div');
            logEl.className = colorClass;
            logEl.innerHTML = `<span class="text-gray-500">[${time}]</span> [${type}] ${msg}`;
            els.logContainer.appendChild(logEl);
            els.logContainer.scrollTop = els.logContainer.scrollHeight;
        }

        // --- 2. æ ¸å¿ƒæœå°‹èˆ‡ç´€éŒ„é‚è¼¯ ---

        function setLoading(isLoading) {
            els.searchBtn.disabled = isLoading;
            if (isLoading) {
                els.btnText.classList.add('hidden');
                els.btnLoader.classList.remove('hidden');
                els.searchBtn.classList.add('opacity-75', 'cursor-not-allowed');
            } else {
                els.btnText.classList.remove('hidden');
                els.btnLoader.classList.add('hidden');
                els.searchBtn.classList.remove('opacity-75', 'cursor-not-allowed');
            }
        }

        els.searchBtn.addEventListener('click', async () => {
            // é©—è­‰æ¬„ä½
            const apiKey = els.serpApiKey.value.trim();
            const clientId = els.googleClientId.value.trim();
            const sheetId = els.googleSheetId.value.trim();
            const targetUrl = els.targetUrl.value.trim();
            const keyword = els.keyword.value.trim();

            if (!apiKey || !clientId || !sheetId || !targetUrl || !keyword) {
                logMsg('ERROR', 'æ‰€æœ‰è¨­å®šèˆ‡æŸ¥è©¢æ¬„ä½çš†ç‚ºå¿…å¡«ï¼');
                alert('è«‹ç¢ºèªæ‰€æœ‰æ¬„ä½ï¼ˆåŒ…å«è¨­å®šå€ï¼‰çš†å·²å¡«å¯«ã€‚');
                return;
            }

            setLoading(true);
            try {
                // æ­¥é©Ÿä¸€ï¼šå‘¼å« SerpApi
                logMsg('INFO', `é–‹å§‹æŸ¥è©¢ SerpApi... (é—œéµå­—: ${keyword}, å¼•æ“: Google, æ•¸é‡: 100)`);
                
                // çµ„åˆ SerpApi ç¶²å€
                const serpUrl = `https://serpapi.com/search.json?engine=google&q=${encodeURIComponent(keyword)}&num=100&api_key=${apiKey}`;
                // ä½¿ç”¨ corsproxy.io ç¹é CORS é™åˆ¶ï¼Œå¿…é ˆå°‡æ•´æ®µ URL encode
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(serpUrl)}`;

                const response = await fetch(proxyUrl);
                if (!response.ok) {
                    throw new Error(`SerpApi è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: ${response.status}`);
                }

                const data = await response.json();
                if (data.error) {
                    throw new Error(`SerpApi éŒ¯èª¤: ${data.error}`);
                }

                const organicResults = data.organic_results || [];
                logMsg('INFO', `æˆåŠŸç²å– SerpApi è³‡æ–™ï¼ŒåŒ…å« ${organicResults.length} ç­†è‡ªç„¶æœå°‹çµæœã€‚æ­£åœ¨æ¯”å°ç¶²å€...`);

                // æ¯”å°ç›®æ¨™ç¶²å€
                let rank = "100åä»¥å¤–";
                let pageTitle = "N/A";

                const match = organicResults.find(result => result.link && result.link.includes(targetUrl));
                
                if (match) {
                    rank = match.position;
                    pageTitle = match.title;
                    logMsg('SUCCESS', `ğŸ‰ æ‰¾åˆ°ç›®æ¨™ç¶²å€ï¼æ’åç¬¬ ${rank} åã€‚ç¶²é æ¨™é¡Œ: "${pageTitle}"`);
                } else {
                    logMsg('WARNING', `æœªåœ¨å‰ 100 åä¸­æ‰¾åˆ°ç›®æ¨™ç¶²å€ã€‚`);
                }

                // æº–å‚™å¯«å…¥ Google Sheets çš„è³‡æ–™
                const currentDate = new Date().toLocaleDateString('zh-TW');
                currentSearchData = {
                    date: currentDate,
                    keyword: keyword,
                    url: targetUrl,
                    rank: rank,
                    title: pageTitle,
                    sheetId: sheetId,
                    clientId: clientId
                };

                // æ­¥é©ŸäºŒï¼šè«‹æ±‚ Google Sheets æ¬Šé™ä¸¦å¯«å…¥
                requestGoogleAuthAndRecord();

            } catch (error) {
                logMsg('ERROR', error.message);
                alert(`ç™¼ç”ŸéŒ¯èª¤ï¼š\n${error.message}`);
                setLoading(false);
            }
        });

        // --- 3. Google Sheets èªè­‰èˆ‡å¯«å…¥ (GSI OAuth 2.0) ---
        let tokenClient;

        function requestGoogleAuthAndRecord() {
            logMsg('INFO', 'æ­£åœ¨è«‹æ±‚ Google OAuth æˆæ¬Š...');
            
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: currentSearchData.clientId,
                    scope: 'https://www.googleapis.com/auth/spreadsheets',
                    callback: async (tokenResponse) => {
                        if (tokenResponse && tokenResponse.access_token) {
                            logMsg('SUCCESS', 'Google æˆæ¬ŠæˆåŠŸï¼Œå–å¾— Access Tokenã€‚');
                            await appendToSheet(tokenResponse.access_token);
                        } else {
                            logMsg('ERROR', 'æœªå–å¾— Access Tokenã€‚');
                            setLoading(false);
                        }
                    },
                    error_callback: (err) => {
                        logMsg('ERROR', `Google æˆæ¬Šå½ˆçª—ç™¼ç”ŸéŒ¯èª¤: ${err.type}`);
                        setLoading(false);
                    }
                });

                // è§¸ç™¼å½ˆçª—è«‹æ±‚æ¬Šé™
                tokenClient.requestAccessToken({prompt: 'consent'});

            } catch (err) {
                logMsg('ERROR', `åˆå§‹åŒ– Google Auth å¤±æ•—ã€‚è«‹ç¢ºèª Client ID æ˜¯å¦æ­£ç¢ºã€‚éŒ¯èª¤å…§å®¹: ${err.message}`);
                setLoading(false);
            }
        }

        async function appendToSheet(accessToken) {
            logMsg('INFO', 'æ­£åœ¨å°‡è³‡æ–™å¯«å…¥ Google Sheets...');
            
            const { sheetId, date, keyword, url, rank, title } = currentSearchData;
            
            // å¯«å…¥çš„ç¯„åœè¨­ç‚º A1:E1ï¼ŒAPI æœƒè‡ªå‹•å¾€ä¸‹å°‹æ‰¾ç©ºç™½åˆ— append
            const apiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/A1:E1:append?valueInputOption=USER_ENTERED`;
            
            const body = {
                values: [
                    [date, keyword, url, rank, title]
                ]
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error ? result.error.message : 'å¯«å…¥ Sheets å¤±æ•—');
                }

                logMsg('SUCCESS', `âœ… è¨˜éŒ„å·²æˆåŠŸå¯«å…¥ Google Sheetsï¼`);
                logMsg('INFO', `æ›´æ–°ç¯„åœ: ${result.updates.updatedRange}`);
                
                // æˆåŠŸå¾Œæ¸…ç©ºæŸ¥è©¢è¼¸å…¥æ¡†ï¼ˆå¯é¸ï¼‰
                // els.keyword.value = '';
                alert(`æŸ¥è©¢æˆåŠŸï¼ç›®å‰æ’åï¼š${rank}\nè³‡æ–™å·²å¯«å…¥ Google Sheetsã€‚`);

            } catch (error) {
                logMsg('ERROR', `å¯«å…¥ Google Sheets æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
                alert(`å¯«å…¥è©¦ç®—è¡¨å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Sheet ID æ¬Šé™æˆ–æ§åˆ¶å°ã€‚\néŒ¯èª¤ï¼š${error.message}`);
            } finally {
                setLoading(false);
            }
        }

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        window.addEventListener('DOMContentLoaded', loadSettings);

    </script>
</body>
</html>